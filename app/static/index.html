<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Chat Render - FastAPI</title>
    <style>
      body { font-family: Inter, Arial; max-width:900px; margin:20px auto; padding:10px; }
      header { display:flex; justify-content:space-between; align-items:center; }
      #messages { border:1px solid #ddd; height:360px; overflow:auto; padding:12px; background:#fafafa; }
      .msg { margin-bottom:8px; padding:6px; border-radius:6px; background:#fff; box-shadow:0 0 0 1px #eee inset; }
      .meta { font-size:12px; color:#666; }
      footer { margin-top:12px; display:flex; gap:8px; }
      input, button { padding:8px; font-size:14px; }
      #status { font-size:13px; color:#222; }
      .system { color:#0a7; font-weight:600; }
    </style>
  </head>
  <body>
    <header>
      <h2>Chat em Nuvem (Render demo)</h2>
      <div id="status">Conectando...</div>
    </header>

    <div id="messages"></div>

    <footer>
      <input id="author" placeholder="Seu nome" style="flex:0 0 150px"/>
      <input id="text" placeholder="Digite mensagem" style="flex:1"/>
      <button id="send">Enviar</button>
      <button id="history">Carregar histórico</button>
    </footer>

    <script>
      const msgDiv = document.getElementById('messages');
      const status = document.getElementById('status');
      const authorInput = document.getElementById('author');
      const textInput = document.getElementById('text');
      const sendBtn = document.getElementById('send');
      const historyBtn = document.getElementById('history');

      const base = location.origin.replace(/\/$/,'');
      const wsProto = base.startsWith('https') ? 'wss' : 'ws';
      const ws = new WebSocket(`${location.origin.replace(/^http/, "ws")}/ws`);


      ws.onopen = () => {
        status.innerText = 'Conectado';
        status.style.color = 'green';
      };
      ws.onclose = () => {
        status.innerText = 'Desconectado';
        status.style.color = 'red';
      };
      ws.onmessage = (evt) => {
        try {
          const d = JSON.parse(evt.data);
          if (d.system) {
            appendSystem(d.system);
            return;
          }
          appendMessage(d);
        } catch (e) {
          console.log('msg raw', evt.data);
        }
      };

      function appendSystem(text){
        const el = document.createElement('div');
        el.className = 'msg system';
        el.textContent = text;
        msgDiv.appendChild(el);
        msgDiv.scrollTop = msgDiv.scrollHeight;
      }

      function appendMessage(m){
        const el = document.createElement('div');
        el.className = 'msg';
        el.innerHTML = `<div class="meta">[${new Date(m.created_at).toLocaleTimeString()}] <strong>${m.author}</strong></div><div>${m.text}</div>`;
        msgDiv.appendChild(el);
        msgDiv.scrollTop = msgDiv.scrollHeight;
      }

      sendBtn.addEventListener('click', () => {
        const author = authorInput.value || 'Anônimo';
        const text = textInput.value;
        if (!text) return;
        ws.send(JSON.stringify({ author, text }));
        textInput.value = '';
      });

      historyBtn.addEventListener('click', async ()=>{
        const res = await fetch('/api/messages?limit=50');
        const rows = await res.json();
        msgDiv.innerHTML = '';
        rows.forEach(appendMessage);
      });
    </script>
  </body>
</html>
